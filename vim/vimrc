"-----------------------------------------------------------
" when you slow down
" Stop And Think
" is there another way to speed up ?
"-----------------------------------------------------------

" General Settings

set nocompatible	" not compatible with the old-fashion vi mode
set bs=2		    " allow backspacing over everything in insert mode
set history=50		" keep 50 lines of command line history
set ruler		    " show the cursor position all the time
set autoread		" auto read when file is changed from outside
set number

filetype off          " necessary to make ftdetect work on Linux
filetype on           " Enable filetype detection
filetype indent on    " Enable filetype-specific indenting
filetype plugin on    " Enable filetype-specific plugins

syntax enable
syntax on		    " syntax highlight
set hlsearch		" search highlighting

set showmatch		" Cursor shows matching ) and }
set showmode		" Show current mode
set wildchar=<TAB>	" start wild expansion in the command line using <TAB>
set wildmenu        " wild char completion menu

" tab show setting
" only show filename, exclude dir
set guitablabel=%m%t

" ignore these files while expanding wild chars
set wildignore+=*.o,*.class,*.pyc,*.swp

set autoindent		" auto indentation
set smartindent     " smart indent
set incsearch		" incremental search
set nobackup		" no *~ backup files
set copyindent		" copy the previous indentation on autoindenting
set ignorecase		" ignore case when searching
set smartcase		" ignore case if search pattern is all lowercase,case-sensitive otherwise
set smarttab		" insert tabs on the start of a line according to context

" disable sound on errors
set noerrorbells
set novisualbell
set t_vb=
set tm=500

set expandtab        "replace <TAB> with spaces, use space only
set tabstop=4        "define <TAB> equal 4 spaces
set softtabstop=4    "
set shiftwidth=4     " auto indent length

set clipboard=unnamed  " share system cliboard
set winaltkeys=no       " don't use alt key

set splitbelow  " split buffer below
set splitright  " split buffer right

" è‡ªåŠ¨åŠ è½½vimrc
" autocmd! bufwritepost .vimrc source %

" open cl buffer when a quickfix command be executed
autocmd QuickFixCmdPost * :cw 


" æœ€åç¼–è¾‘çš„æ–‡ä»¶ä¿å­˜å…‰æ ‡ï¼Œä¸‹æ¬¡æ‰“å¼€è¯¥æ–‡ä»¶è‡ªåŠ¨åœç•™åœ¨ä¸Šæ¬¡ç¼–è¾‘çš„åœ°æ–¹
set viminfo='10,\"100,:20,%,n~/.viminfo
au BufReadPost * if line("'\"") > 0|if line("'\"") <= line("$")|exe("norm '\"")|else|exe "norm $"|endif|endif

"-----------------------------------------------
" pmenu
"-----------------------------------------------
"---- show 10 items in insert mode complete pop menu
set pumheight=20
set pumwidth=20

"-----------------------------------------------
" file type
"-----------------------------------------------

au FileType Makefile set noexpandtab

" --- for python
au BufNewFile,BufRead *.py
    \ set tabstop=4 |
    \ set softtabstop=4 |
    \ set shiftwidth=4 |
    \ set textwidth=79 |
    \ set expandtab |
    \ set autoindent |
    \ set fileformat=unix

au BufNewFile,BufRead *.js,*.html,*.css
    \ set tabstop=2 |
    \ set softtabstop=2 |
    \ set shiftwidth=2

highlight BadWhitespace ctermbg=red guibg=darkred
au BufRead,BufNewFile *.py,*.pyw match BadWhitespace /\s\+$/

" -- for proto
 augroup filetype
   au! BufRead,BufNewFile *.proto setfiletype proto
 augroup end

" -- cindent
autocmd FileType c,cpp,cc  set cindent

"-----------------------------------------------
" functions
"-----------------------------------------------
function! CurDir()
    let curdir = substitute(getcwd(), $HOME, "~", "")
    return curdir
endfunction

function! HasPaste()
    if &paste
        return '[PASTE]'
    else
        return ''
    endif
endfunction

"--------------------------------------------------------------------------- 
" USEFUL SHORTCUTS
"--------------------------------------------------------------------------- 
" set leader to ,
let mapleader=","
let g:mapleader=","

" --- move around splits
nmap <silent> <C-j> :wincmd j<CR>
nmap <silent> <C-k> :wincmd k<CR>
nmap <silent> <C-h> :wincmd h<CR>
nmap <silent> <C-l> :wincmd l<CR>

" move around tabs. conflict with the original screen top/bottom
" comment them out if you want the original H/L
" go to prev tab 
map <S-H> gT
" go to next tab
map <S-L> gt

" new tab
map <leader>tn :tabnew<CR>
" close tab
map <leader>tc :tabclose<CR> 

" ,/ turn off search highlighting
nmap <leader>/ :nohl<CR>

" Bash like keys for the command line
cnoremap <C-a>      <Home>
cnoremap <C-e>      <End>

" ,ps toggles paste mode
nmap <leader>ps :set paste!<BAR>set paste?<CR>

" allow multiple indentation/deindentation in visual mode
vnoremap < <gv
vnoremap > >gv

" è‡ªåŠ¨åˆ‡æ¢åˆ°å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç›®å½• cdpath
map <Leader>cd :cd %:h<CR>

"--------------------------------------------------------------------------- 
" PROGRAMMING SHORTCUTS
"--------------------------------------------------------------------------- 

" ,g generates the header guard
" map <leader>g :call IncludeGuard()<CR>

fun! IncludeGuard()
   let basename = substitute(bufname(""), '.*/', '', '')
   let guard = '_' . substitute(toupper(basename), '\.', '_', "H")
   call append(0, "#ifndef " . guard)
   call append(1, "#define " . guard)
   call append( line("$"), "#endif // for #ifndef " . guard)
endfun

set cot-=preview "disable doc preview in omnicomplete

"--------------------------------------------------------------------------- 
" ENCODING SETTINGS
"--------------------------------------------------------------------------- 
set encoding=utf-8                                  
set termencoding=utf-8
set fileencoding=utf-8
set fileencodings=ucs-bom,utf-8,big5,gb2312,latin1,cp936,gbk,gb18030

lang messages zh_CN.UTF-8 " è§£å†³consleè¾“å‡ºä¹±ç  
" lang messages en_Us.UTF-8 " è§£å†³consleè¾“å‡ºä¹±ç  


fun! ViewUTF8()
	set encoding=utf-8                                  
	set termencoding=big5
endfun

fun! UTF8()
	set encoding=utf-8                                  
	set termencoding=big5
	set fileencoding=utf-8
	set fileencodings=ucs-bom,big5,utf-8,latin1
endfun

fun! Big5()
	set encoding=big5
	set fileencoding=big5
endfun


"--------------------------------------------------------------------------- 
" PLUGIN SETTINGS
"--------------------------------------------------------------------------- 

" æ’ä»¶å¼€å§‹çš„ä½ç½®
call plug#begin('~/.vim/plugged')

" ç”¨æ¥æä¾›ä¸€ä¸ªå¯¼èˆªç›®å½•çš„ä¾§è¾¹æ 
Plug 'scrooloose/nerdtree'

" Vim ä¸­æ–‡æ–‡æ¡£
Plug 'yianwillis/vimcdoc'

" å¯ä»¥å¿«é€Ÿå¯¹é½çš„æ’ä»¶
Plug 'junegunn/vim-easy-align'

" git plugin
Plug 'tpope/vim-fugitive'

" å¯ä»¥åœ¨æ–‡æ¡£ä¾§è¾¹ä¸­æ˜¾ç¤º git ä¿¡æ¯
Plug 'airblade/vim-gitgutter'

" æŸ¥çœ‹å½“å‰ä»£ç æ–‡ä»¶ä¸­çš„å˜é‡å’Œå‡½æ•°åˆ—è¡¨çš„æ’ä»¶ï¼Œ
" å¯ä»¥åˆ‡æ¢å’Œè·³è½¬åˆ°ä»£ç ä¸­å¯¹åº”çš„å˜é‡å’Œå‡½æ•°çš„ä½ç½®
" å¤§çº²å¼å¯¼èˆª, Go éœ€è¦ https://github.com/jstemmer/gotags æ”¯æŒ
Plug 'majutsushi/tagbar'

" è‡ªåŠ¨è¡¥å…¨æ‹¬å·çš„æ’ä»¶ï¼ŒåŒ…æ‹¬å°æ‹¬å·ï¼Œä¸­æ‹¬å·ï¼Œä»¥åŠèŠ±æ‹¬å·
Plug 'jiangmiao/auto-pairs'

" VimçŠ¶æ€æ æ’ä»¶ï¼ŒåŒ…æ‹¬æ˜¾ç¤ºè¡Œå·ï¼Œåˆ—å·ï¼Œæ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶åï¼Œä»¥åŠGitçŠ¶æ€
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'

" é…è‰²æ–¹æ¡ˆ
Plug 'rakr/vim-one'
Plug 'NLKNguyen/papercolor-theme'
Plug 'liuchengxu/space-vim-theme'

" go ä¸»è¦æ’ä»¶
Plug 'fatih/vim-go', { 'tag': '*' }
Plug 'neoclide/coc.nvim', {'branch': 'release'}

" markdown æ’ä»¶
Plug 'iamcco/mathjax-support-for-mkdp'
Plug 'iamcco/markdown-preview.vim'

" è‡ªåŠ¨ç”Ÿæˆæ³¨é‡Šçš„æ’ä»¶
Plug 'scrooloose/nerdcommenter'

" easy motion
Plug 'easymotion/vim-easymotion'

" fzf
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --bin' }
Plug 'junegunn/fzf.vim'

" surround
Plug 'tpope/vim-surround'

" yankstack
Plug 'maxbrunsfeld/vim-yankstack'

" visual-increment
Plug 'triglav/vim-visual-increment'

" æ’ä»¶ç»“æŸçš„ä½ç½®ï¼Œæ’ä»¶å…¨éƒ¨æ”¾åœ¨æ­¤è¡Œä¸Šé¢
call plug#end()

"==============================================================================
" vim-go æ’ä»¶
"==============================================================================
let g:go_fmt_command = "goimports" " æ ¼å¼åŒ–å°†é»˜è®¤çš„ gofmt æ›¿æ¢
let g:go_autodetect_gopath = 1
let g:go_list_type = "quickfix"

let g:go_version_warning = 1
let g:go_highlight_types = 1
let g:go_highlight_fields = 1
let g:go_highlight_functions = 1
let g:go_highlight_function_calls = 1
let g:go_highlight_operators = 1
let g:go_highlight_extra_types = 1
let g:go_highlight_methods = 1
let g:go_highlight_generate_tags = 1

" ä½¿ç”¨cocçš„å®šä¹‰è·³è½¬ï¼Œå°‘å¼€ä¸€ä¸ªgopls
let g:go_def_mode = 'guru'
let g:go_info_mode = 'gocode'
let g:go_def_mapping_enabled = 0 
let g:go_doc_keywordprg_enabled = 0 " use coc' K

" vim-go æä¾›äº†:GoDeclså‘½ä»¤æ¥åœ¨å½“å‰bufferæ‰¾å‡ºå‡½æ•°
" ç±»ä¼¼coc-listçš„<space-o>ï¼Œè¿˜æ˜¯ä½¿ç”¨cocçš„å‘½ä»¤
" vim-goé‡Œ ]], [[æ¥åœ¨å½“å‰çš„bufferçš„å‡½æ•°é—´è·³è½¬
" coc-listé‡Œè®¾ç½®äº†<space-j>,<space-k>ï¼Œä¸è¿‡è¦
" äº‹å…ˆæ‰§è¡Œè¿‡ä¸€æ¬¡<space-o>ï¼Œå¯ä»¥éšæ„é€‰æ‹©ã€‚

"==============================================================================
" coc.nvim æ’ä»¶
"==============================================================================
" è£…å®Œcocåéœ€è¦é…ç½®goplsä½œä¸ºlsp server
" :CocConfig
"{
"  "languageserver": {
"    "golang": {
"      "command": "gopls",
"      "rootPatterns": ["go.mod", ".git/", ".hg/"],
"      "filetypes": ["go"]
"    }
"  }
"}
"
" å®‰è£…coc-list
" :CocInstall coc-lists
"
" å®‰è£…coc-json, æä¾›é…ç½®è¡¥å…¨
" :CocInstall coc-json
"
" é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥é‡å¯cocæœåŠ¡
" :CocRestart
" ------------------------------------------------------
" if hidden is not set, TextEdit might fail.
set hidden
set nowritebackup

" Better display for messages
" set cmdheight=2

" You will have bad experience for diagnostic messages when it's default 4000.
set updatetime=300

" don't give |ins-completion-menu| messages.
set shortmess+=c

" always show signcolumns
set signcolumn=yes

" Use tab for trigger completion with characters ahead and navigate.
" Use command ':verbose imap <tab>' to make sure tab is not mapped by other plugin.
inoremap <silent><expr> <TAB>
      \ pumvisible() ? "\<C-n>" :
      \ <SID>check_back_space() ? "\<TAB>" :
      \ coc#refresh()
inoremap <expr><S-TAB> pumvisible() ? "\<C-p>" : "\<C-h>"

function! s:check_back_space() abort
  let col = col('.') - 1
  return !col || getline('.')[col - 1]  =~# '\s'
endfunction

" Use <c-tab> to trigger completionï¼Œå¼ºè¡Œè§¦å‘è¡¥å…¨
inoremap <silent><expr> <c-tab> coc#refresh()

" Use <cr> to confirm completion, `<C-g>u` means break undo chain at current position.
" Coc only does snippet and additional edit on confirm.
inoremap <expr> <cr> pumvisible() ? "\<C-y>" : "\<C-g>u\<CR>"

" Use `[c` and `]c` to navigate diagnostics
nmap <silent> [c <Plug>(coc-diagnostic-prev)
nmap <silent> ]c <Plug>(coc-diagnostic-next)

" Remap keys for gotos
nmap <silent> gd <Plug>(coc-definition)
" nmap <silent> gy <Plug>(coc-type-definition)
" nmap <silent> gi <Plug>(coc-implementation)
" nmap <silent> gr <Plug>(coc-references)

" Use K to show documentation in preview window
nnoremap <silent>K :call <SID>show_documentation()<CR>

function! s:show_documentation()
  if (index(['vim','help'], &filetype) >= 0)
    execute 'h '.expand('<cword>')
  else
    call CocAction('doHover')
  endif
endfunction

" Highlight symbol under cursor on CursorHold
autocmd CursorHold * silent call CocActionAsync('highlight')

" Remap for rename current word
nmap <leader>rn <Plug>(coc-rename)

" Remap for format selected region
" xmap <leader>f  <Plug>(coc-format-selected)
" nmap <leader>f  <Plug>(coc-format-selected)

augroup mygroup
  autocmd!
  " Setup formatexpr specified filetype(s).
  autocmd FileType typescript,json setl formatexpr=CocAction('formatSelected')
  " Update signature help on jump placeholder
  autocmd User CocJumpPlaceholder call CocActionAsync('showSignatureHelp')
augroup end

" Remap for do codeAction of selected region, ex: `<leader>aap` for current paragraph
xmap <leader>a  <Plug>(coc-codeaction-selected)
nmap <leader>a  <Plug>(coc-codeaction-selected)

" Remap for do codeAction of current line
nmap <leader>ac  <Plug>(coc-codeaction)
" Fix autofix problem of current line
nmap <leader>qf  <Plug>(coc-fix-current)

" Use <tab> for select selections ranges, needs server support, like: coc-tsserver, coc-python
nmap <silent> <TAB> <Plug>(coc-range-select)
xmap <silent> <TAB> <Plug>(coc-range-select)
xmap <silent> <S-TAB> <Plug>(coc-range-select-backword)

" Use `:Format` to format current buffer
command! -nargs=0 Format :call CocAction('format')

" Use `:Fold` to fold current buffer
command! -nargs=? Fold :call     CocAction('fold', <f-args>)

" use `:OR` for organize import of current buffer
command! -nargs=0 OR   :call     CocAction('runCommand', 'editor.action.organizeImport')

" Add status line support, for integration with other plugin, checkout `:h coc-status`
set statusline^=%{coc#status()}%{get(b:,'coc_current_function','')}

" Using CocList
" Show all diagnostics
nnoremap <silent> <space>a  :<C-u>CocList diagnostics<cr>

" Manage extensions
" nnoremap <silent> <space>e  :<C-u>CocList extensions<cr>
" Show commands
" nnoremap <silent> <space>c  :<C-u>CocList commands<cr>

" Find symbol of current document å¯ä»¥å½“ä½œalt-mç”¨
nnoremap <silent> <space>o  :<C-u>CocList outline<cr>

" Search workspace symbols
" nnoremap <silent> <space>s  :<C-u>CocList -I symbols<cr>

" Do default action for next item. ä¸‹é¢è¿™2ä¸ªæŒ‰é”®ï¼Œå¯ä»¥åœ¨coclistçš„å‡½æ•°é—´ç§»åŠ¨
nnoremap <silent> <space>j  :<C-u>CocNext<CR>
" Do default action for previous item.
nnoremap <silent> <space>k  :<C-u>CocPrev<CR>

" Resume latest coc list
nnoremap <silent> <leader>p  :<C-u>CocListResume<CR>

"==============================================================================
" NerdTree æ’ä»¶
"==============================================================================
" æ‰“å¼€å’Œå…³é—­NERDTreeå¿«æ·é”®
map <leader>nt :NERDTreeToggle<CR>
map <F4> :NERDTreeMirror<CR>

" è‡ªåŠ¨å®šä½åˆ°nerdtree
map <leader>nf :NERDTreeFind<CR>zz<C-l> 

" æ˜¯å¦æ˜¾ç¤ºéšè—æ–‡ä»¶
let NERDTreeShowHidden=1

" å¿½ç•¥ä¸€ä¸‹æ–‡ä»¶çš„æ˜¾ç¤º
let NERDTreeIgnore=['\.pyc','\~$','\.swp','\.git']

"==============================================================================
"  majutsushi/tagbar æ’ä»¶
"==============================================================================

" majutsushi/tagbar æ’ä»¶æ‰“å¼€å…³é—­å¿«æ·é”®
nnoremap <silent> <F7> :TagbarToggle<CR> 

" set focus to TagBar when opening it
let g:tagbar_autofocus = 1       

"gotagä½¿ç”¨æ–¹æ³•: gotags -f tags -R .
let g:tagbar_type_go = {
	\ 'ctagstype' : 'go',
	\ 'kinds'     : [
		\ 'p:package',
		\ 'i:imports:1',
		\ 'c:constants',
		\ 'v:variables',
		\ 't:types',
		\ 'n:interfaces',
		\ 'w:fields',
		\ 'e:embedded',
		\ 'm:methods',
		\ 'r:constructor',
		\ 'f:functions'
	\ ],
	\ 'sro' : '.',
	\ 'kind2scope' : {
		\ 't' : 'ctype',
		\ 'n' : 'ntype'
	\ },
	\ 'scope2kind' : {
		\ 'ctype' : 't',
		\ 'ntype' : 'n'
	\ },
	\ 'ctagsbin'  : 'gotags',
	\ 'ctagsargs' : '-sort -silent'
\ }

fun! GenGoTags()
   execute('!gotags -f tags -R .') 
endfun

nnoremap <silent> <F8> :call GenGoTags()<CR> 

"==============================================================================
"  fzf
"==============================================================================
" export FZF_DEFAULT_COMMAND="rg --files "
" export FZF_DEFAULT_OPTS="--layout=reverse --inline-info"

nnoremap <silent> <C-p> :FZF -e<CR> 
nnoremap <silent> <Leader>b :Buffers<CR> 
nnoremap <silent> <Leader>f :Rg<CR> 

let g:fzf_buffers_jump = 1 " [Buffers] å¦‚æœå¯èƒ½è·³åˆ°å·²å­˜åœ¨çª—å£
let g:fzf_action = {
  \ 'ctrl-o': 'edit',
  \ 'ctrl-t': 'tab split',
  \ 'ctrl-x': 'split',
  \ 'ctrl-v': 'vsplit' }

" å¼€å¯å†å²ç›®å½•åï¼Œåœ¨fzfçš„äº¤äº’ç•Œé¢ä½¿ç”¨ctrl-n, ctrl-pæ¥é€‰æ‹©ä¹‹å‰çš„è¾“å…¥å†å²
let g:fzf_history_dir = '~/.local/share/fzf-history'

"==============================================================================
"  EasyMotion
"==============================================================================
" ä½¿ç”¨<space>w, <space>bæ¥è·³è½¬
map <space> <Plug>(easymotion-prefix)

hi link EasyMotionTarget ErrorMsg
hi link EasyMotionShade  Comment

"==============================================================================
"  vim-terminal
"==============================================================================
map <silent> <leader>tt :term powershell<CR>
map <silent> <leader>ttb :term bash<CR>
tnoremap <F1> <C-W>N


"==============================================================================
"  yankstack
"==============================================================================
" :Yankå‘½ä»¤æŸ¥çœ‹å½“å‰çš„å¾ªç¯åˆ—è¡¨å†…å®¹
call yankstack#setup()
nmap Y y$
nmap <space>p <Plug>yankstack_substitute_older_paste
" nmap <space>P <Plug>yankstack_substitute_newer_paste

"==============================================================================
" vim-easy-align
"==============================================================================
" Start interactive EasyAlign in visual mode (e.g. vip<Enter>)
vmap <Enter> <Plug>(EasyAlign)

"==============================================================================
" airline
"==============================================================================
" let g:airline_theme='one'
let g:airline_theme='papercolor'
let g:airline_section_b = 'î‚  %{fugitive#head()}'
let g:airline#extensions#tagbar#enabled = 0
let g:airline#extensions#whitespace#checks = [] " ä¸æ£€æŸ¥spaceç”¨æ³•æ˜¯å¦é”™è¯¯

"==============================================================================
" visual-increment
"==============================================================================
" ä¸‹é¢è®¾ç½®ctrl-a,ctrl-xå…‰æ ‡ä¸‹çš„baseè¿›åˆ¶
set nrformats=alpha,octal,hex

"==============================================================================
"  å…¶ä»–æ’ä»¶é…ç½®
"==============================================================================
" markdwon çš„å¿«æ·é”®
map <silent> <F5> <Plug>MarkdownPreview
map <silent> <F6> <Plug>StopMarkdownPreview

" è‡ªåŠ¨æ³¨é‡Šçš„æ—¶å€™æ·»åŠ ç©ºæ ¼
let g:NERDSpaceDelims=1

" git setting
let g:gitgutter_max_signs = 9999  " ä¸€ä¸ªbufferé‡Œæœ€å¤šæ˜¾ç¤ºsignæ•°é‡

"==============================================================================
" GUIçš„è®¾ç½®è¦æ”¾åœ¨æœ€åï¼ŒåŠ è½½å®Œæ’ä»¶å
"==============================================================================
function! SetGUIFront()
    if(has("win32") || has("win64"))
        au GUIEnter * simalt ~x  " è®¾ç½®å¯åŠ¨æ—¶çª—å£çš„å¤§å°
        " set guifont=Fira\ Code:h13
        " set guifont=Courier\ New:h13
        set guifont=Source\ Code\ Pro:h14
        set background=dark 
    elseif has("linux")
        set lines=999 columns=999
        set guifont=Courier\ New:h14
        set background=dark 
    elseif has("mac")
        set lines=999 columns=999
        set guifont=Courier\ New:h18
        set background=dark 
    endif 
endfunction

if has("gui_running")	
  :call SetGUIFront()

  set guioptions -=T    " not toolbar
  set guioptions -=m    " not menubar
  set guioptions -=b    " not bottom scroll bar
  set guioptions -=l    " not left hand scroll bar
  set guioptions -=r    " not right hand scroll bar
  set guioptions -=L    " not left hand scroll bar in vsplit windows
  set guioptions -=R    " not rihgt hand scroll bar in vsplit windows
  set termguicolors

  " colorscheme PaperColor 
  colorscheme space_vim_theme 
  set background=dark 

  set cursorline        " highlight current line
  highlight CursorLine          guibg=#003853 ctermbg=24  gui=none cterm=none
else
  " terminal color settings
  colors vgod
endif

"==============================================================================
" my macros
"==============================================================================
let @q = '_f*s:proto.w~ea(),lDj'

